{% extends "base.html" %}

{% block title %}Sales Conversation{% endblock %}
 
{% block extra_head %}
<style>
    :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
    }

    body {
        background-color: var(--light-bg);
    }

    .conversation-container {
        height: calc(100vh - 120px);
        max-height: 800px;
    }

    .chat-section {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 8px 8px 0 0;
    }

    .chat-input-area {
        padding: 1rem;
        background: white;
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
    }

    .message {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-content {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.4;
    }

    .message.user .message-content {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
        background: white;
        color: #333;
        border: 1px solid var(--border-color);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .message-time {
        font-size: 0.75rem;
        color: var(--secondary-color);
        margin-top: 0.25rem;
        padding: 0 0.5rem;
    }

    .message.user .message-time {
        align-self: flex-end;
        text-align: right;
    }

    .message.assistant .message-time {
        align-self: flex-start;
    }

    .details-panel {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: fit-content;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 500;
        color: var(--secondary-color);
    }

    .detail-value {
        font-weight: 600;
        color: #333;
    }

    .detail-missing {
        color: var(--danger-color);
        font-style: italic;
    }

    .typing-indicator {
        display: none;
        color: var(--secondary-color);
        font-style: italic;
        margin-bottom: 0.5rem;
    }

    .typing-spinner {
        display: inline-block;
        width: 8px;
        height: 8px;
        border: 1px solid #ccc;
        border-top: 1px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-bar-custom {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--success-color), #20c997);
        width: 0%;
        transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
        .conversation-container {
            height: calc(100vh - 100px);
        }
        
        .details-panel {
            margin-top: 1rem;
        }

        .message-content {
            max-width: 90%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row g-3">
        <!-- Main Chat Area -->
        <div class="col-lg-8 col-12">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-comments me-2"></i>
                                Sales Conversation
                            </h5>
                            <small class="opacity-75">Lead: {{ lead_id }}</small>
                        </div>
                        <span class="badge bg-success">
                            <i class="fas fa-circle me-1"></i>
                            Connected
                        </span>
                    </div>
                </div>

                <div class="conversation-container">
                    <div class="chat-section">
                        <div class="chat-messages" id="chatMessages">
                            {% if response %}
                            <div class="message assistant">
                                <div class="message-content">
                                    {{ response|safe }}
                                </div>
                                <div class="message-time">
                                    <i class="fas fa-clock me-1"></i>
                                    <span id="initialTime"></span>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="chat-input-area">
                            <div class="typing-indicator" id="typingIndicator">
                                <span class="typing-spinner"></span>
                                Agent is typing...
                            </div>

                            <div class="input-group">
                                <input 
                                    type="text" 
                                    class="form-control form-control-lg" 
                                    id="messageInput" 
                                    placeholder="Type your message here..."
                                    autocomplete="off"
                                >
                                <button 
                                    class="btn btn-primary btn-lg" 
                                    type="button" 
                                    id="sendButton"
                                >
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Sidebar -->
        <div class="col-lg-4 col-12">
            <div class="details-panel">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-user-circle me-2"></i>
                    Customer Details
                </h6>

                <div id="customerDetails">
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value" id="customerName">Not provided</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Age:</span>
                        <span class="detail-value" id="customerAge">Not provided</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Country:</span>
                        <span class="detail-value" id="customerCountry">Not provided</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Interest:</span>
                        <span class="detail-value" id="customerInterest">Not provided</span>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Profile Completion</small>
                        <small class="fw-bold" id="completionText">0%</small>
                    </div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <h6 class="fw-bold mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="requestSuggestions()">
                            <i class="fas fa-lightbulb me-2"></i>
                            Get Suggestions
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showHistory()">
                            <i class="fas fa-history me-2"></i>
                            View History
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="endChat()">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            End Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Configuration
const LEAD_ID = '{{ lead_id }}';
let isWebSocketConnected = false;
let messageQueue = [];

// DOM Elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

// Initialize Socket.IO
const socket = io();

// WebSocket Event Handlers
socket.on('connect', function() {
    isWebSocketConnected = true;
    console.log('WebSocket connected');
    
    // Join conversation room
    socket.emit('join_conversation', { lead_id: LEAD_ID });
    
    // Process any queued messages
    processMessageQueue();
});

socket.on('disconnect', function() {
    isWebSocketConnected = false;
    console.log('WebSocket disconnected');
});

socket.on('message_update', function(data) {
    if (data.lead_id === LEAD_ID) {
        addMessageToChat(data.message, data.role, data.timestamp);
        hideTypingIndicator();
    }
});

socket.on('user_status', function(data) {
    if (data.lead_id === LEAD_ID) {
        updateCustomerDetails(data.collected_details);
        updateProgress(data.details_complete, data.missing_details);
    }
});

socket.on('error', function(data) {
    console.error('WebSocket error:', data.message);
    hideTypingIndicator();
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial timestamp
    const initialTime = document.getElementById('initialTime');
    if (initialTime) {
        initialTime.textContent = new Date().toLocaleTimeString();
    }
    
    // Focus input
    messageInput.focus();
    
    // Add event listeners
    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
    
    // Get initial status
    if (isWebSocketConnected) {
        socket.emit('get_user_status', { lead_id: LEAD_ID });
    }
});

// Message Handling
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Clear input and show typing
    messageInput.value = '';
    showTypingIndicator();
    
    if (isWebSocketConnected) {
        // Send via WebSocket
        socket.emit('send_message', {
            lead_id: LEAD_ID,
            message: message
        });
    } else {
        // Fallback to HTTP
        sendMessageHTTP(message);
    }
}

function sendMessageHTTP(message) {
    // Add user message immediately for HTTP fallback
    addMessageToChat(message, 'user', new Date().toISOString());
    
    fetch(`/chat?lead_id=${LEAD_ID}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            addMessageToChat(data.response, 'assistant', new Date().toISOString());
            
            // Update details if provided
            if (data.collected_details) {
                updateCustomerDetails(data.collected_details);
            }
            updateProgress(data.details_complete, data.missing_details);
        }
        hideTypingIndicator();
    })
    .catch(error => {
        console.error('HTTP Error:', error);
        hideTypingIndicator();
        addMessageToChat('Sorry, there was an error sending your message. Please try again.', 'assistant', new Date().toISOString());
    });
}

function addMessageToChat(content, role, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = content.replace(/\n/g, '<br>');
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.innerHTML = `<i class="fas fa-clock me-1"></i>${new Date(timestamp).toLocaleTimeString()}`;
    
    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(timeDiv);
    chatMessages.appendChild(messageDiv);
    
    // Auto scroll
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

function showTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.style.display = 'block';
    }
}

function hideTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.style.display = 'none';
    }
}

function updateCustomerDetails(details) {
    if (!details) return;
    
    const fields = {
        'customerName': details.name || 'Not provided',
        'customerAge': details.age || 'Not provided',
        'customerCountry': details.country || 'Not provided',
        'customerInterest': details.interest || 'Not provided'
    };
    
    Object.keys(fields).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = fields[id];
            
            if (fields[id] === 'Not provided') {
                element.classList.add('detail-missing');
            } else {
                element.classList.remove('detail-missing');
            }
        }
    });
}

function updateProgress(isComplete, missingDetails) {
    const totalFields = 4;
    const completedFields = totalFields - (missingDetails ? missingDetails.length : totalFields);
    const percentage = Math.round((completedFields / totalFields) * 100);
    
    const completionText = document.getElementById('completionText');
    const progressFill = document.getElementById('progressFill');
    
    if (completionText) {
        completionText.textContent = percentage + '%';
    }
    
    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
}

function processMessageQueue() {
    while (messageQueue.length > 0) {
        const message = messageQueue.shift();
        sendMessage(message);
    }
}

// Quick Actions
function requestSuggestions() {
    messageInput.value = "Can you show me some product suggestions?";
    sendMessage();
}

function showHistory() {
    if (isWebSocketConnected) {
        socket.emit('get_conversation_history', { lead_id: LEAD_ID });
    }
}

function endChat() {
    if (confirm('Are you sure you want to end this conversation?')) {
        messageInput.value = "Thank you for your help. I'm ending our conversation now.";
        sendMessage();
        
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
    }
}

// Event listeners are now added in DOMContentLoaded above
</script>
{% endblock %} 