{% extends "base.html" %}

{% block title %}Conversation - Sales Agent System{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary-color: #007bff;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --border-color: #dee2e6;
        --success-color: #28a745;
        --danger-color: #dc3545;
    }
    
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        background: white;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 400px;
    }
    
    .chat-input-container {
        padding: 1rem 1.5rem;
        background: white;
        border-top: 1px solid var(--border-color);
    }
    
    .message {
        margin-bottom: 1rem;
        animation: slideIn 0.3s ease-out;
        display: flex;
        flex-direction: column;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message-bubble {
        padding: 0.875rem 1.25rem;
        border-radius: 18px;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    
    .message.user .message-bubble {
        background: linear-gradient(135deg, var(--primary-color), #6366f1);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 6px;
    }
    
    .message.assistant .message-bubble {
        background: white;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        margin-right: auto;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .message.system .message-bubble {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fbbf24;
        margin: 0 auto;
        text-align: center;
        font-style: italic;
        border-radius: 12px;
        max-width: 70%;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        align-self: flex-end;
    }
    
    .message.user .message-time {
        align-self: flex-end;
        text-align: right;
    }
    
    .message.assistant .message-time {
        align-self: flex-start;
        text-align: left;
    }
    
    .user-details-panel {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 500;
        color: var(--text-secondary);
    }
    
    .detail-value {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .detail-missing {
        color: var(--danger-color);
        font-style: italic;
    }
    
    .completion-progress {
        margin-top: 1rem;
    }
    
    .typing-indicator {
        display: none;
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.875rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .status-online {
        background-color: var(--success-color);
    }
    
    .status-offline {
        background-color: var(--danger-color);
    }
    
    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .status-connected {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    
    .status-disconnected {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .chat-container {
            height: 60vh;
        }
        
        .user-details-panel {
            margin-top: 1rem;
        }
        
        .connection-status {
            top: 10px;
            right: 10px;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8 col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            Sales Conversation
                        </h5>
                        <small class="opacity-75">Lead ID: {{ lead_id }}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-online me-2"></span>
                        <span id="connectionStatus">Connected</span>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Initial message -->
                        {% if response %}
                        <div class="message assistant">
                            <div class="message-bubble">
                                {{ response|safe }}
                            </div>
                            <div class="message-time">
                                <i class="fas fa-clock me-1"></i>
                                <span id="initialTime"></span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="typing-indicator mb-2" id="typingIndicator">
                            <span class="loading-spinner"></span>
                            Agent is typing...
                        </div>
                        
                        <div class="input-group">
                            <input 
                                type="text" 
                                class="form-control form-control-lg" 
                                id="messageInput" 
                                placeholder="Type your message here..."
                                autocomplete="off"
                            >
                            <button 
                                class="btn btn-primary btn-lg" 
                                type="button" 
                                id="sendButton"
                            >
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Details Panel -->
        <div class="col-lg-4 col-md-12">
            <div class="user-details-panel">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-user-circle me-2"></i>
                    Customer Details
                </h6>
                
                <div id="userDetails">
                    <div class="detail-item">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value" id="detailName">Not provided</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Age:</span>
                        <span class="detail-value" id="detailAge">Not provided</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Country:</span>
                        <span class="detail-value" id="detailCountry">Not provided</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Interest:</span>
                        <span class="detail-value" id="detailInterest">Not provided</span>
                    </div>
                </div>
                
                <div class="completion-progress">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Profile Completion</small>
                        <small class="fw-bold" id="completionPercentage">0%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div 
                            class="progress-bar bg-success" 
                            role="progressbar" 
                            id="completionBar"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card mt-3 border-0 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="requestSuggestions()">
                            <i class="fas fa-lightbulb me-2"></i>
                            Get Product Suggestions
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showConversationHistory()">
                            <i class="fas fa-history me-2"></i>
                            View History
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="endConversation()">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            End Conversation
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status Indicator -->
<div class="connection-status status-connected" id="globalConnectionStatus">
    <i class="fas fa-wifi me-1"></i>
    Connected
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// WebSocket connection
const socket = io();
const leadId = '{{ lead_id }}';
let isConnected = false;

// DOM elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set initial time
    const initialTimeEl = document.getElementById('initialTime');
    if (initialTimeEl) {
        initialTimeEl.textContent = new Date().toLocaleTimeString();
    }
    
    // Focus on input
    if (messageInput) {
        messageInput.focus();
    }
    
    // Join conversation room
    socket.emit('join_conversation', { lead_id: leadId });
    
    // Get initial user status
    socket.emit('get_user_status', { lead_id: leadId });
    
    // Load conversation history
    socket.emit('get_conversation_history', { lead_id: leadId });
});

// WebSocket event handlers
socket.on('connect', function() {
    isConnected = true;
    updateConnectionStatus(true);
    console.log('Connected to WebSocket');
});

socket.on('disconnect', function() {
    isConnected = false;
    updateConnectionStatus(false);
    console.log('Disconnected from WebSocket');
});

socket.on('message_update', function(data) {
    if (data.lead_id === leadId) {
        addMessage(data.message, data.role, data.timestamp);
        hideTypingIndicator();
    }
});

socket.on('user_status', function(data) {
    if (data.lead_id === leadId) {
        updateUserDetails(data.collected_details);
        updateCompletionProgress(data.details_complete, data.missing_details);
    }
});

socket.on('conversation_history', function(data) {
    if (data.lead_id === leadId && data.history.length > 0) {
        // Clear existing messages except the initial one
        const messages = chatMessages.querySelectorAll('.message');
        for (let i = 1; i < messages.length; i++) {
            messages[i].remove();
        }
        
        // Add history messages
        data.history.forEach(function(message) {
            if (message.role !== 'system') {
                addMessage(message.content, message.role, message.timestamp);
            }
        });
    }
});

socket.on('follow_up_message', function(data) {
    if (data.lead_id === leadId) {
        addMessage(data.message, 'assistant', data.timestamp);
        showNotification('Follow-up message received', 'info');
    }
});

socket.on('error', function(data) {
    console.error('WebSocket error:', data.message);
    showNotification('Connection error: ' + data.message, 'error');
});

// Message handling functions
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message immediately
    addMessage(message, 'user', new Date().toISOString());
    
    // Clear input and show typing indicator
    messageInput.value = '';
    showTypingIndicator();
    
    // Send via WebSocket if connected
    if (isConnected) {
        socket.emit('send_message', {
            lead_id: leadId,
            message: message
        });
    } else {
        // Fallback to HTTP
        sendMessageHTTP(message);
    }
}

function sendMessageHTTP(message) {
    fetch(`/chat?lead_id=${leadId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            addMessage(data.response, 'assistant', new Date().toISOString());
            if (data.collected_details) {
                updateUserDetails(data.collected_details);
            }
            updateCompletionProgress(data.details_complete, data.missing_details);
        }
        hideTypingIndicator();
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
        showNotification('Failed to send message', 'error');
    });
}

function addMessage(content, role, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const timeStr = new Date(timestamp).toLocaleTimeString();
    
    // Create message bubble
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.innerHTML = content.replace(/\n/g, '<br>');
    
    // Create time element
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.innerHTML = `<i class="fas fa-clock me-1"></i>${timeStr}`;
    
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    
    chatMessages.appendChild(messageDiv);
    
    // Smooth scroll to bottom
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

function showTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.style.display = 'block';
    }
}

function hideTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.style.display = 'none';
    }
}

function updateUserDetails(details) {
    if (!details) return;
    
    const elements = {
        'detailName': details.name || 'Not provided',
        'detailAge': details.age || 'Not provided',
        'detailCountry': details.country || 'Not provided',
        'detailInterest': details.interest || 'Not provided'
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = elements[id];
            
            // Update classes for missing details
            if (elements[id] === 'Not provided') {
                element.classList.add('detail-missing');
            } else {
                element.classList.remove('detail-missing');
            }
        }
    });
}

function updateCompletionProgress(isComplete, missingDetails) {
    const totalFields = 4;
    const completedFields = totalFields - (missingDetails ? missingDetails.length : totalFields);
    const percentage = Math.round((completedFields / totalFields) * 100);
    
    const percentageEl = document.getElementById('completionPercentage');
    const barEl = document.getElementById('completionBar');
    
    if (percentageEl) {
        percentageEl.textContent = percentage + '%';
    }
    
    if (barEl) {
        barEl.style.width = percentage + '%';
        
        if (percentage === 100) {
            barEl.classList.remove('bg-success');
            barEl.classList.add('bg-primary');
        }
    }
}

function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connectionStatus');
    const globalStatus = document.getElementById('globalConnectionStatus');
    
    if (connected) {
        if (statusElement) statusElement.textContent = 'Connected';
        if (globalStatus) {
            globalStatus.className = 'connection-status status-connected';
            globalStatus.innerHTML = '<i class="fas fa-wifi me-1"></i>Connected';
        }
    } else {
        if (statusElement) statusElement.textContent = 'Disconnected';
        if (globalStatus) {
            globalStatus.className = 'connection-status status-disconnected';
            globalStatus.innerHTML = '<i class="fas fa-wifi-slash me-1"></i>Disconnected';
        }
    }
}

function showNotification(message, type) {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 70px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Quick action functions
function requestSuggestions() {
    const message = "Can you show me some product suggestions?";
    messageInput.value = message;
    sendMessage();
}

function showConversationHistory() {
    socket.emit('get_conversation_history', { lead_id: leadId, limit: 100 });
}

function endConversation() {
    if (confirm('Are you sure you want to end this conversation?')) {
        const message = "Thank you for your time. I'm ending our conversation now. Have a great day!";
        messageInput.value = message;
        sendMessage();
        
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
    }
}

// Event listeners
if (sendButton) {
    sendButton.addEventListener('click', sendMessage);
}

if (messageInput) {
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// Periodic status updates
setInterval(function() {
    if (isConnected) {
        socket.emit('get_user_status', { lead_id: leadId });
    }
}, 30000); // Every 30 seconds
</script>
{% endblock %} 