{% extends "base.html" %}

{% block title %}Conversation - Sales Agent System{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 12px 12px 0 0;
    }
    
    .chat-input-container {
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 0 0 12px 12px;
        border-top: 1px solid var(--border-color);
    }
    
    .message {
        margin-bottom: 1rem;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message-bubble {
        padding: 0.875rem 1.25rem;
        border-radius: 18px;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.4;
    }
    
    .message.user .message-bubble {
        background: linear-gradient(135deg, var(--primary-color), #6366f1);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 6px;
    }
    
    .message.assistant .message-bubble {
        background: white;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        margin-right: auto;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .message.system .message-bubble {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fbbf24;
        margin: 0 auto;
        text-align: center;
        font-style: italic;
        border-radius: 12px;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    
    .user-details-panel {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 500;
        color: var(--text-secondary);
    }
    
    .detail-value {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .detail-missing {
        color: #ef4444;
        font-style: italic;
    }
    
    .completion-progress {
        margin-top: 1rem;
    }
    
    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 1000;
    }
    
    .status-connected {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    
    .status-disconnected {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Chat Interface -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Sales Conversation
                    </h5>
                    <small class="opacity-75">Lead ID: {{ lead_id }}</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-online me-2"></span>
                    <span id="connectionStatus">Connected</span>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Initial message -->
                    {% if response %}
                    <div class="message assistant">
                        <div class="message-bubble">
                            {{ response|safe }}
                        </div>
                        <div class="message-time text-end">
                            <i class="fas fa-clock me-1"></i>
                            <span id="initialTime"></span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="chat-input-container">
                    <div class="input-group">
                        <input 
                            type="text" 
                            class="form-control form-control-lg" 
                            id="messageInput" 
                            placeholder="Type your message here..."
                            autocomplete="off"
                        >
                        <button 
                            class="btn btn-primary btn-lg" 
                            type="button" 
                            id="sendButton"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <div class="typing-indicator mt-2" id="typingIndicator">
                        <span class="loading-spinner"></span>
                        Agent is typing...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Details Panel -->
    <div class="col-lg-4">
        <div class="user-details-panel">
            <h6 class="fw-bold mb-3">
                <i class="fas fa-user-circle me-2"></i>
                Customer Details
            </h6>
            
            <div id="userDetails">
                <div class="detail-item">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value" id="detailName">Not provided</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Age:</span>
                    <span class="detail-value" id="detailAge">Not provided</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Country:</span>
                    <span class="detail-value" id="detailCountry">Not provided</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Interest:</span>
                    <span class="detail-value" id="detailInterest">Not provided</span>
                </div>
            </div>
            
            <div class="completion-progress">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Profile Completion</small>
                    <small class="fw-bold" id="completionPercentage">0%</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div 
                        class="progress-bar bg-success" 
                        role="progressbar" 
                        id="completionBar"
                        style="width: 0%"
                    ></div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3 border-0 bg-light">
            <div class="card-body">
                <h6 class="fw-bold mb-3">Quick Actions</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="requestSuggestions()">
                        <i class="fas fa-lightbulb me-2"></i>
                        Get Product Suggestions
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="showConversationHistory()">
                        <i class="fas fa-history me-2"></i>
                        View History
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="endConversation()">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        End Conversation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status Indicator -->
<div class="connection-status status-connected" id="globalConnectionStatus">
    <i class="fas fa-wifi me-1"></i>
    Connected
</div>
{% endblock %}

{% block extra_js %}
<script>
// WebSocket connection
const socket = io();
const leadId = '{{ lead_id }}';
let isConnected = false;

// DOM elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

// Initialize
$(document).ready(function() {
    // Set initial time
    $('#initialTime').text(new Date().toLocaleTimeString());
    
    // Focus on input
    messageInput.focus();
    
    // Join conversation room
    socket.emit('join_conversation', { lead_id: leadId });
    
    // Get initial user status
    socket.emit('get_user_status', { lead_id: leadId });
    
    // Load conversation history
    socket.emit('get_conversation_history', { lead_id: leadId });
});

// WebSocket event handlers
socket.on('connect', function() {
    isConnected = true;
    updateConnectionStatus(true);
    console.log('Connected to WebSocket');
});

socket.on('disconnect', function() {
    isConnected = false;
    updateConnectionStatus(false);
    console.log('Disconnected from WebSocket');
});

socket.on('message_update', function(data) {
    if (data.lead_id === leadId) {
        addMessage(data.message, data.role, data.timestamp);
        hideTypingIndicator();
    }
});

socket.on('user_status', function(data) {
    if (data.lead_id === leadId) {
        updateUserDetails(data.collected_details);
        updateCompletionProgress(data.details_complete, data.missing_details);
    }
});

socket.on('conversation_history', function(data) {
    if (data.lead_id === leadId && data.history.length > 0) {
        // Clear existing messages except the initial one
        $('#chatMessages .message').not(':first').remove();
        
        // Add history messages
        data.history.forEach(function(message) {
            if (message.role !== 'system') {
                addMessage(message.content, message.role, message.timestamp);
            }
        });
    }
});

socket.on('follow_up_message', function(data) {
    if (data.lead_id === leadId) {
        addMessage(data.message, 'assistant', data.timestamp);
        showNotification('Follow-up message received', 'info');
    }
});

socket.on('error', function(data) {
    console.error('WebSocket error:', data.message);
    showNotification('Connection error: ' + data.message, 'error');
});

// Message handling functions
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || !isConnected) return;
    
    // Add user message immediately
    addMessage(message, 'user', new Date().toISOString());
    
    // Clear input and show typing indicator
    messageInput.value = '';
    showTypingIndicator();
    
    // Send via WebSocket
    socket.emit('send_message', {
        lead_id: leadId,
        message: message
    });
    
    // Fallback to HTTP if WebSocket fails
    setTimeout(function() {
        if (typingIndicator.style.display !== 'none') {
            sendMessageHTTP(message);
        }
    }, 5000);
}

function sendMessageHTTP(message) {
    fetch(`/chat?lead_id=${leadId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            addMessage(data.response, 'assistant', new Date().toISOString());
            if (data.collected_details) {
                updateUserDetails(data.collected_details);
            }
            updateCompletionProgress(data.details_complete, data.missing_details);
        }
        hideTypingIndicator();
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
        showNotification('Failed to send message', 'error');
    });
}

function addMessage(content, role, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const timeStr = new Date(timestamp).toLocaleTimeString();
    const alignClass = role === 'user' ? 'text-start' : 'text-end';
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${content}
        </div>
        <div class="message-time ${alignClass}">
            <i class="fas fa-clock me-1"></i>
            ${timeStr}
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    typingIndicator.style.display = 'block';
}

function hideTypingIndicator() {
    typingIndicator.style.display = 'none';
}

function updateUserDetails(details) {
    document.getElementById('detailName').textContent = details.name || 'Not provided';
    document.getElementById('detailAge').textContent = details.age || 'Not provided';
    document.getElementById('detailCountry').textContent = details.country || 'Not provided';
    document.getElementById('detailInterest').textContent = details.interest || 'Not provided';
    
    // Update classes for missing details
    ['Name', 'Age', 'Country', 'Interest'].forEach(field => {
        const element = document.getElementById('detail' + field);
        if (details[field.toLowerCase()]) {
            element.classList.remove('detail-missing');
        } else {
            element.classList.add('detail-missing');
        }
    });
}

function updateCompletionProgress(isComplete, missingDetails) {
    const totalFields = 4;
    const completedFields = totalFields - (missingDetails ? missingDetails.length : totalFields);
    const percentage = Math.round((completedFields / totalFields) * 100);
    
    document.getElementById('completionPercentage').textContent = percentage + '%';
    document.getElementById('completionBar').style.width = percentage + '%';
    
    if (percentage === 100) {
        document.getElementById('completionBar').classList.remove('bg-success');
        document.getElementById('completionBar').classList.add('bg-primary');
    }
}

function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connectionStatus');
    const globalStatus = document.getElementById('globalConnectionStatus');
    
    if (connected) {
        statusElement.textContent = 'Connected';
        globalStatus.className = 'connection-status status-connected';
        globalStatus.innerHTML = '<i class="fas fa-wifi me-1"></i>Connected';
    } else {
        statusElement.textContent = 'Disconnected';
        globalStatus.className = 'connection-status status-disconnected';
        globalStatus.innerHTML = '<i class="fas fa-wifi-slash me-1"></i>Disconnected';
    }
}

function showNotification(message, type) {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 70px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Quick action functions
function requestSuggestions() {
    const message = "Can you show me some product suggestions?";
    messageInput.value = message;
    sendMessage();
}

function showConversationHistory() {
    socket.emit('get_conversation_history', { lead_id: leadId, limit: 100 });
}

function endConversation() {
    if (confirm('Are you sure you want to end this conversation?')) {
        const message = "Thank you for your time. I'm ending our conversation now. Have a great day!";
        messageInput.value = message;
        sendMessage();
        
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
    }
}

// Event listeners
sendButton.addEventListener('click', sendMessage);

messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize input
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});

// Periodic status updates
setInterval(function() {
    if (isConnected) {
        socket.emit('get_user_status', { lead_id: leadId });
    }
}, 30000); // Every 30 seconds
</script>
{% endblock %} 